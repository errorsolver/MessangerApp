<%- include('../partials/head.ejs') %>

<body>
  <div class="container">
    <div>
      <h1>Contact</h1>
      <ul id="ulContact">
      </ul>
    </div>
    <div>
      <h1>Message</h1>
      <ul class="" id="ulMessages"></ul>

      <form>
        <input type="text" id="inputMessage">
        <button type="submit">Send</button>
      </form>

    </div>
  </div>

  <script>
    const getContactUL = document.getElementById("ulContact")
    const getUsers = async () => {
      try {
        const res = await fetch('/user/getusers', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        })

        const result = await res.json()
        let users = result.users

        users.forEach(e => {
          const createLI = document.createElement('li')

          createLI.id = e.id
          createLI.textContent = e.username
          createLI.addEventListener('click', (e) => {
            saveReceiverId(e)
            getMessage()
          })
          getContactUL.appendChild(createLI)
        })
      } catch (error) {
        console.log('error: ', error)
      }
    }

    const saveReceiverId = (detail) => {
      if (!detail.target.id) throw 'need target id'
        const targetId = detail.target.id
        localStorage.selectedUser = targetId
    }
    const getMessagesUL = document.getElementById('ulMessages')
    const getMessage = async () => {
      try {
        getMessagesUL.innerHTML = ''
        receiverId = localStorage.selectedUser

        const res = await fetch('/message/get', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            receiverId
          })
        })

        const result = await res.json()
        const senderMessages = await result.senderMessages
        const receiverMessages = await result.receiverMessages

        const messages = []
        senderMessages.forEach(e => {
          if (e.receiverId != e.senderId) {
            messages.push(e)
          }
        })
        receiverMessages.forEach(e => {
          if (e.receiverId != e.senderId) {
            messages.push(e)
          }
        })
        messages.sort((a, b) => a.id - b.id)

        messages.forEach(e => {
          const createLI = document.createElement('li')
          createLI.id = e.senderId
          createLI.textContent = e.message
          // createLI.classList.add('inline', 'list-group-item')
          if (createLI.id != localStorage.selectedUser) {
            createLI.classList.add('text-end')
          }
          getMessagesUL.appendChild(createLI)
        })

        if (!getMessagesUL.hasChildNodes()) {
          const createLI = document.createElement('li')
          createLI.textContent = 'There is no message'
          getMessagesUL.appendChild(createLI)
        }
      } catch (error) {
        console.log('error: ', error);
      }
    }

    window.onload = () => {
      getUsers()
    }

    const sendMessageForm = document.querySelector('form')
    sendMessageForm.addEventListener('submit', async (e) => {
      try {
        e.preventDefault()
        await sendMessages()
        await getMessage()
      } catch (error) {
        console.log(error)
      }
    })

    async function sendMessages() {
      const getInputMessage = document.getElementById('inputMessage')
      const message = getInputMessage.value
      const receiverId = localStorage.selectedUser
      try {
        const result = await fetch('/message/send', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message,
            receiverId
          })
        })
      } catch (error) {
        console.log('send message: ', error);
      }
    }
  </script>
</body>